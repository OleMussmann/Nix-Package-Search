name: Cargo Build & Test

on:
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: release nps
    runs-on: ubuntu-latest
    steps:
      - name: Create release text
        run: |
          echo grep "## \[" CHANGELOG.md | head -n 2 | tail -n 1 | sed "s/^## \\[\(.*\)\\].*/\1/" >> $TAG
          echo "Tag: '${TAG}'"
          sed -e "/^## \\[${TAG}\\]/,/^## / ! d" CHANGELOG.md | head -n -2 > RELEASE.md
          echo >> RELEASE.md
          sed -e "/^\\[${TAG}\\]: / ! d;s/^\\[${TAG}\\]: \(.*\)/**Full Changelog**: \1/" CHANGELOG.md >> RELEASE.md
          echo "Release text:"
          cat RELEASE.md
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo grep "## \[" CHANGELOG.md | head -n 2 | tail -n 1 | sed "s/^## \\[\(.*\)\\].*/\1/" >> $TAG
          gh release create v"$TAG" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${GITHUB_REPOSITORY#*/} v${TAG#v}" \
              --notes-file="./RELEASE.md" \
              --draft
